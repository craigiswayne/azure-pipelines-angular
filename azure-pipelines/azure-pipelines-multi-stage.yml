trigger:
  batch: true
  branches:
    include:
      - '*'

pr:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - template: _variables.yml

stages:
  - stage: StageJobInstallLintBuildTest
    displayName: 'Install, Lint, Build and Test'
    jobs:
      - job: JobInstallLintBuildTest
        displayName: 'Build'
        steps:
          - template: _install-lint-build.yml
            parameters:
              isProd: ${{ variables.isProd }}

  - stage: StageManualProdDeploy
    displayName: 'PROD Deploy Approval: Playground Angular'
    dependsOn: StageJobInstallLintBuildTest
    jobs:
      - job: JobApproval
        displayName: 'Approval for Prod Deploy'
        pool: server
        steps:
          # https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/manual-validation-v0?view=azure-pipelines
          - task: ManualValidation@0
            inputs:
#              notifyUsers: |
#                user@example.com
              instructions: 'On Approval, performs a PROD Deploy'
#              onTimeout: 'resume'

  - stage: DeployPROD
    displayName: 'Deploy: PROD'
    dependsOn: StageManualProdDeploy
    jobs:
      - deployment: Deploy
        displayName: 'Deploy: PROD'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: none
                - checkout: none
                - task: DownloadBuildArtifacts@1
                  displayName: Download artifacts
                  inputs:
                    buildType: current
                    downloadType: single
                    artifactName: '$(ARTIFACT_NAME_PROD)'
                    downloadPath: $(System.ArtifactsDirectory)
                - task: AzureStaticWebApp@0
                  displayName: 'Deploy: PROD'
                  inputs:
                    build_timeout_in_minutes: 5
                    workingDirectory: '$(System.ArtifactsDirectory)/$(ARTIFACT_NAME_PROD)'
                    deployment_environment: ''
                    app_location: '/'
                    # Look inside this directory for the staticwebapp.config.json file
                    # This file allows you to further configure your static web app
                    # https://learn.microsoft.com/en-us/azure/static-web-apps/configuration
                    config_file_location: '/'
                    # We do not need to build our app since it is already done in previous steps
                    # https://github.com/microsoft/Oryx/blob/main/doc/configuration.md
                    skip_app_build: true
                    skip_api_build: true
                    is_static_export: true
                    verbose: true
                    # defined in the pipeline library variable group
                    # see the variables properties above
                    azure_static_web_apps_api_token: '$(AZURE_STATIC_WEB_APPS_API_TOKEN)'

  - stage: DeployUAT
    displayName: 'Deploy: UAT'
    dependsOn: StageJobInstallLintBuildTest
    jobs:
      - template: '_job_deploy.yml'
        parameters:
          env: 'uat'
          ARTIFACT_NAME: '$(ARTIFACT_NAME_UAT)'
